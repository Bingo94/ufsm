![](https://github.com/jonpe960/ufsm/raw/master/doc/logo.png)

[![Coverity](https://scan.coverity.com/projects/15860/badge.svg)](https://scan.coverity.com/projects/jonpe960-ufsm)
[![Build Status](https://travis-ci.org/jonpe960/ufsm.svg?branch=master)](https://travis-ci.org/jonpe960/ufsm)
[![Coverage Status](https://coveralls.io/repos/github/jonpe960/ufsm/badge.svg)](https://coveralls.io/github/jonpe960/ufsm)
[![codecov](https://codecov.io/gh/jonpe960/ufsm/branch/master/graph/badge.svg)](https://codecov.io/gh/jonpe960/ufsm)

uFSM is a statechart library written in C. uFSM is designed without any external dependencies and uses no dynamic memory allocation or recursion.

uFSM is desiged with embedded applications in mind but can also be used in other environments. 

Supported UML statchart features:

| Feature              | Implemented | Test case                              |
| -------------------- |:-----------:| -------------------------------------- |
| Simple state         | Yes         | test_simple                            |
| Composit states      | Yes         | test_simple_substate, test_xmi_machine |
| Submachines          | Yes         | test_xmi_machine                       |
| Compound transition  | Yes         | test_compound_transition               |
| Fork                 | Yes         | test_fork                              |
| Join                 | Yes         | test_join                              |
| Guards/Actions       | Yes         | test_guards_actions + various          |
| Shallow/Deep history | Yes         | test_xmi_machine, test_deephistory     | 
| exit/entry points    | Yes         | test_compound_transition               |
| Init/Final           | Yes         | all                                    |
| Event deferral       | Yes         | test_deferr                            |
| Terminate            | Yes         | test_terminate                         |
| Choice               | Yes         | test_choice                            |
| Junction             | Yes         | test_junction                          |
| Do activity          | No          |                                        |

Future work:
 - Some proper examples
 - Simulation/Analysis tool
 - Test XMI files from other tools
 - Maybe support SCXML data

# Examples
All examples are located in 'src/examples'. Some of the examples have specific
 platform dependancies. For example 'dhcpclient' will only work with linux.

## dhcpclient



# Implementation details & metrics

## Transitions
The UML specification does not enforce how transitions are owned but suggests 
that the transition should be owned by the least common region, which makes sense. 
This however comes at a much greater computational cost in the transition algorithm. 
uFSM stores the transition in the region where the source state is located.

## Event deferral
uFSM implements event deferral by using a local transition on the state where
an event should be deferred. The local transition should have an action with
the name 'ufsm_deferr'. This is a special keyword which is detected by
the transition algorithm. Whenever an 'ufsm_deferr' action is found
the event will be stored on a deferred event queue.

## Do activiies
Do activities are not implemented.

## Code complexity and memory usage
uFSM is desiged with embedded and safety critical applications in mind. 
uFSM does not use any dynamic memory allocation and uses no recursion.
Instead uFSM uses a statically allocated stack 'ufsm_stack'. The stack depth
can be adjusted by setting 'UFSM_STACK_SIZE' build variable.

Functions with highest cyclomatic complexity:

| CCN | LoC   | Function                   |
|:---:|:-----:| ---------------------------|
| 15  | 124   | ufsm_make_transition       |
| 13  | 54    | ufsm_process               |
| 13  | 48    | ufsm_process_final_state   |
| 12  | 50    | ufsm_enter_parent_states   |
| 10  | 37    | ufsm_leave_nested_states   |

# Description of test cases

All of the statecharts were drawn in StarUML and the XMI files generated with the 'XMI' plugin.

## XMI machine

This is a mixture of different tests. Most notably:
 - The acutal state machines are generated by importing an XMI file, using ufsmimport
 - Use of sub statemachines
 - Shallow history
 - Orthogonal regions

![](https://github.com/jonpe960/ufsm/raw/master/doc/test_xmi_machine1.png)
Top level state machine

![](https://github.com/jonpe960/ufsm/raw/master/doc/test_xmi_machine2.png)
Sub statemachine

## Deep history

![](https://github.com/jonpe960/ufsm/raw/master/doc/test_deephistory.png)



## Compound transitions

![](https://github.com/jonpe960/ufsm/raw/master/doc/test_compound_transition.png)

This statechart is taken from the UML standard, see chapter 14.2.3.9.6 for a complete description.

'test_compound_transition' tests entry and exits of parent states up until a least common ancestor. When event 'sig' is dispatched the transition algoritm executes the following: xS11; t1; xS1; t2; eT1; eT11; t3; eT111

## Fork

![](https://github.com/jonpe960/ufsm/raw/master/doc/test_fork.png)



